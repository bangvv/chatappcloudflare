<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat App</title>
  <style>
		 body, html {
			height: 100%;
			margin: 0;
		  }

		  body {
			display: flex;
			justify-content: center; /* cƒÉn ngang gi·ªØa */
			align-items: center;     /* cƒÉn d·ªçc gi·ªØa */
			background: #f5f5f5;
		  }

		  #formSection {
			background: white;
			padding: 20px 30px;
			border-radius: 12px;
			box-shadow: 0 4px 12px rgba(0,0,0,0.1);
			display: flex;
			flex-wrap: wrap;
			gap: 12px 20px;
			max-width: 400px;
			justify-content: center;
		  }

		  #formSection label {
			flex: 1 1 100%; /* m·ªói label chi·∫øm m·ªôt d√≤ng */
			font-weight: 600;
			font-size: 16px;
		  }

		  #formSection input,
		  #formSection select {
			width: 100%;
			padding: 8px 10px;
			margin-top: 6px;
			font-size: 16px;
			border: 1px solid #ccc;
			border-radius: 8px;
			box-sizing: border-box;
		  }

		  #connectBtn {
			flex: 1 1 100%;
			margin-top: 10px;
			padding: 12px;
			font-size: 18px;
			background-color: #007bff;
			color: white;
			border: none;
			border-radius: 10px;
			cursor: pointer;
		  }

		  #connectBtn:hover {
			background-color: #0056b3;
		  }

	#chatWrapper {
		display: none;
		justify-content: center; /* cƒÉn ngang gi·ªØa */
		align-items: center;     /* cƒÉn d·ªçc gi·ªØa */
		width: 100%;
		height: 100%;
		max-width: 1200px;

	}

  #chatBox {
    width: 100%;
	height: 100%;
    max-width: 100%;
    background: white;
    border-radius: 12px;
    padding: 5px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    gap: 10px;
    box-sizing: border-box;
  }

  #topBar {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  #status {
    font-size: 14px;
    color: #333;
  }
  
.menu-wrapper {
  position: relative;
  display: inline-block;
}

#menuBtn {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
}

.menu-dropdown {
  display: none;
  position: absolute;
  right: 0;
  background-color: white;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  border-radius: 8px;
  overflow: hidden;
  z-index: 10;
  min-width: 120px;
}

.menu-item {
  padding: 10px 14px;
  cursor: pointer;
  font-size: 14px;
  border-bottom: 1px solid #eee;
}

.menu-item:last-child {
  border-bottom: none;
}

.menu-item:hover {
  background-color: #f2f2f2;
}

  

  #messages {
	flex: 1;
	overflow-y: auto;
	padding: 10px;
	border: 1px solid #ddd;
	border-radius: 8px;
	background: #f9f9f9;
	font-size: 14px;
	scroll-behavior: smooth;
  }
	#messages .me {
		color: #003333;
		align-self: flex-end;
		margin-left: auto;
		text-align: right;
	}

	#messages .partner {
		color: black;
		align-self: flex-start;
		margin-right: auto;
		text-align: left;
	}

	#inputArea {
	  bottom: 0;
	  left: 0;
	  right: 0;
	  width: 100%;
	  display: flex;
	  gap: 10px;
	  padding: 10px 0px 0px 0px;
	  background-color: white;
	  border-top: 1px solid #ccc;
	  box-sizing: border-box;
	  /* b·ªè margin-top n·∫øu c√≥ */
	  margin-top: 0;
	}


	#msgInput {
	  flex: 1;
	  padding: 8px;
	  font-size: 16px;
	}

	#sendBtn {
	  padding: 8px 16px;
	  font-size: 16px;
	  background-color: #007bff;
	  color: white;
	  border: none;
	  border-radius: 4px;
	  cursor: pointer;
	}

  @media (min-width: 768px) {
	#chatBox {
	  max-width: 50%;
	}
  }
  </style>
</head>
<body>

<div id="formSection">
	<h1>T√¨m b·∫°n chat</h1>
  <label>T√™n: <input id="name"/></label>
  <label>Tu·ªïi: <input id="age" type="number"/></label>
  <label>Gi·ªõi t√≠nh: 
    <select id="gender">
      <option value="">Ch·ªçn</option>
      <option value="male">Nam</option>
      <option value="female">N·ªØ</option>
    </select>
  </label>
  <label>V·ªã tr√≠: 
    <select id="vitri">
      <option value="">Ch·ªçn</option>
      <option value="mienbac">B·∫Øc</option>
      <option value="mientrung">Trung</option>
	  <option value="miennam">Nam</option>
    </select>
  </label>
  <label>Mu·ªën t√¨m: 
    <select id="lookingFor">
      <option value="">Ch·ªçn</option>
      <option value="male">Nam</option>
      <option value="female">N·ªØ</option>
    </select>
  </label>
  <button id="connectBtn">K·∫øt n·ªëi</button>
  <div id="statusConnect"></div>
</div>

<div id="chatWrapper">
  <div id="chatBox">
    <div id="topBar">
      <div id="status">ƒêang k·∫øt n·ªëi...</div>
      
		<div class="menu-wrapper">
			<button id="menuBtn">‚ãÆ</button>
			<div id="menuDropdown" class="menu-dropdown">
				<div class="menu-item" id="reportBtn">üö´ B√°o c√°o</div>
				<div class="menu-item" id="disconnectBtn">üö™ Tho√°t</div>
			</div>
		</div>
    </div>
    <div id="messages"></div>
		<div id="inputArea">
			<input id="msgInput" placeholder="Nh·∫≠p tin nh·∫Øn..." />
			<button id="sendBtn">G·ª≠i</button>
		</div>
  </div>
</div>

<script>
  let ws;
  let currentRoomId = null;

  const status = document.getElementById("status");
  const formSection = document.getElementById("formSection");
  const chatBox = document.getElementById("chatWrapper");
  const messages = document.getElementById("messages");
  const statusConnect = document.getElementById("statusConnect");
  const menuBtn = document.getElementById("menuBtn");
  const menuDropdown = document.getElementById("menuDropdown");
  
	menuBtn.onclick = () => {
	  menuDropdown.style.display = menuDropdown.style.display === "block" ? "none" : "block";
	};

	// B·∫•m ngo√†i ƒë·ªÉ ƒë√≥ng menu
	window.addEventListener("click", function(e) {
	  if (!menuBtn.contains(e.target) && !menuDropdown.contains(e.target)) {
		menuDropdown.style.display = "none";
	  }
	});

	// X·ª≠ l√Ω b√°o c√°o
	document.getElementById("reportBtn").onclick = () => {
	  if (ws) {
		ws.send(JSON.stringify({
		  event: "report",
		  roomId: currentRoomId,
		  message: "T√¥i mu·ªën b√°o c√°o ng∆∞·ªùi n√†y"
		}));
	  }
	  alert("ƒê√£ b√°o c√°o ng∆∞·ªùi n√†y v√† tho√°t cu·ªôc tr√≤ chuy·ªán.");
	  resetUI();
	  status.textContent = "ƒê√£ b√°o c√°o v√† tho√°t";
	  ws.close();
	};

  document.getElementById("connectBtn").onclick = () => {
    const name = document.getElementById("name").value.trim();
    const age = document.getElementById("age").value.trim();
    const gender = document.getElementById("gender").value;
	const vitri = document.getElementById("vitri").value;
    const lookingFor = document.getElementById("lookingFor").value;

    if (!name || !age || !gender || !lookingFor|| !vitri) {
      alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin");
      return;
    }

    const url = `${location.origin.replace(/^http/, 'ws')}/chat?name=${encodeURIComponent(name)}&age=${age}&gender=${gender}&vitri=${vitri}&lookingFor=${lookingFor}`;
    ws = new WebSocket(url);
	console.log("url:",url)
	
    ws.onopen = () => {
      status.textContent = "ƒêang t√¨m b·∫°n chat...";
	  statusConnect.textContent = "ƒêang t√¨m b·∫°n chat...";
    };

    ws.onmessage = (event) => {
		const data = JSON.parse(event.data);

		if (data.event === "matched") {
			currentRoomId = data.roomId;
			status.textContent = `ƒê√£ gh√©p n·ªëi v·ªõi ${data.partner.name}`;
			formSection.style.display = "none";
			chatBox.style.display = "flex";
		}

		if (data.event === "chat") {
			appendMessage(`${data.message}`, "partner");
		}
	  
		if (data.event === "partner_left") {
			console.log("Ng∆∞·ªùi kia ƒë√£ r·ªùi kh·ªèi cu·ªôc tr√≤ chuy·ªán.");
			alert("Ng∆∞·ªùi kia ƒë√£ r·ªùi kh·ªèi cu·ªôc tr√≤ chuy·ªán.");
			resetUI();
			return;
		}
	  
    };

    ws.onclose = () => {
		resetUI();
      resetUI();
    };

    ws.onerror = () => {
      status.textContent = "L·ªói k·∫øt n·ªëi";
    };
  };

  document.getElementById("sendBtn").onclick = () => {
    const input = document.getElementById("msgInput");
    const msg = input.value.trim();
    if (msg && ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({
        event: "chat",
        roomId: currentRoomId,
        message: msg
      }));
      appendMessage(`${msg}`, "me");
      input.value = "";
    }
  };

  document.getElementById("msgInput").addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      document.getElementById("sendBtn").click();
    }
  });

  document.getElementById("disconnectBtn").onclick = () => {
    if (ws) {
		ws.send(JSON.stringify({
			event: "partner_left",
			roomId: currentRoomId,
			message: "Ng∆∞·ªùi kia ƒë√£ tho√°t kh·ªèi cu·ªôc tr√≤ chuy·ªán"
      }));
    }
    resetUI();
    status.textContent = "ƒê√£ tho√°t kh·ªèi cu·ªôc tr√≤ chuy·ªán";
	ws.close();
  };
  
	window.addEventListener("resize", () => {
		scrollToBottom();
	});

	function appendMessage(text, cls) {
		const div = document.createElement("div");
		div.textContent = text;
		div.className = cls;
		messages.appendChild(div);

		// ƒê·∫£m b·∫£o n·ªôi dung ƒë∆∞·ª£c render tr∆∞·ªõc khi cu·ªôn
		requestAnimationFrame(() => {
		messages.scrollTop = messages.scrollHeight;
		});
	}
	
	function scrollToBottom() {
		requestAnimationFrame(() => {
			messages.scrollTop = messages.scrollHeight;
		});
	}

  function resetUI() {
    formSection.style.display = "flex";
	statusConnect.textContent = ""
    chatBox.style.display = "none";
    messages.innerHTML = "";
    document.getElementById("msgInput").value = "";
    currentRoomId = null;
  }
</script>

</body>
</html>